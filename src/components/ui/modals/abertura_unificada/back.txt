import { useState, useEffect, useRef, useLayoutEffect, useMemo } from 'react'
import {
  Modal,
  ModalContent,
  ModalHeader,
  ModalBody,
  ModalFooter,
  Button,
  useDisclosure,
} from '@heroui/react'
import { Stage, Layer, Group, Rect, Text } from 'react-konva'
import { v4 as uuidv4 } from 'uuid'
import ModalConfiguracion from './ModalConfiguracion'
import { SiMaterialdesignicons } from 'react-icons/si'

// --- CONSTANTES ---
const INITIAL_ESCALA = 0.2
const SPACING = 20
const PADDING_STAGE = 80
const STORAGE_KEY = 'diseno_modulos_pro_editor'

export interface Modulo {
  id: string
  x: number
  y: number
  tipo: string
  ancho: number
  alto: number
}

export default function AberturaCompuesta() {
  const [tipo, setTipo] = useState<string>('Paño Fijo')
  const [ancho, setAncho] = useState<number>(1000)
  const [alto, setAlto] = useState<number>(1000)

  const {
    isOpen: isThisOpen,
    onOpen: onThisOpen,
    onOpenChange: onThisOpenChange,
  } = useDisclosure()
  const {
    isOpen: isOpenConfig,
    onOpen: onOpenConfig,
    onOpenChange: onOpenChangeConfig,
  } = useDisclosure()

  const containerRef = useRef<HTMLDivElement>(null)
  const [dimensions, setDimensions] = useState({ width: 0, height: 0 })

  useLayoutEffect(() => {
    if (isThisOpen) {
      const updateSize = () => {
        if (containerRef.current) {
          const { offsetWidth, offsetHeight } = containerRef.current
          if (offsetWidth > 0 && offsetHeight > 0) {
            setDimensions({ width: offsetWidth, height: offsetHeight })
          }
        }
      }
      const timer = setTimeout(updateSize, 300)
      window.addEventListener('resize', updateSize)
      return () => {
        window.removeEventListener('resize', updateSize)
        clearTimeout(timer)
      }
    }
  }, [isThisOpen])

  const [modulos, setModulos] = useState<Modulo[]>(() => {
    if (typeof window !== 'undefined') {
      const saved = localStorage.getItem(STORAGE_KEY)
      return saved ? JSON.parse(saved) : []
    }
    return []
  })

  const [selectedId, setSelectedId] = useState<string | null>(null)
  const [isEditing, setIsEditing] = useState(false)
  const [targetCoords, setTargetCoords] = useState<{
    x: number
    y: number
  } | null>(null)

  useEffect(() => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(modulos))
  }, [modulos])

  const obtenerPosicionVisual = (coordX: number, coordY: number) => {
    let visualX = 0
    let visualY = 0
    if (coordX > 0) {
      for (let i = 0; i < coordX; i++) {
        const m =
          modulos.find((mod) => mod.x === i && mod.y === coordY) ||
          modulos.find((mod) => mod.x === i)
        visualX += (m?.ancho || 1000) * INITIAL_ESCALA
      }
    } else if (coordX < 0) {
      for (let i = -1; i >= coordX; i--) {
        const m =
          modulos.find((mod) => mod.x === i && mod.y === coordY) ||
          modulos.find((mod) => mod.x === i)
        visualX -= (m?.ancho || 1000) * INITIAL_ESCALA
      }
    }
    if (coordY > 0) {
      for (let j = 0; j < coordY; j++) {
        const m =
          modulos.find((mod) => mod.y === j && mod.x === coordX) ||
          modulos.find((mod) => mod.y === j)
        visualY += (m?.alto || 1000) * INITIAL_ESCALA
      }
    } else if (coordY < 0) {
      for (let j = -1; j >= coordY; j--) {
        const m =
          modulos.find((mod) => mod.y === j && mod.x === coordX) ||
          modulos.find((mod) => mod.y === j)
        visualY -= (m?.alto || 1000) * INITIAL_ESCALA
      }
    }
    return { x: visualX, y: visualY }
  }

  const transform = useMemo(() => {
    if (modulos.length === 0 || dimensions.width === 0)
      return { x: 50, y: 50, scale: 1 }
    const bounds = modulos.map((m) => {
      const pos = obtenerPosicionVisual(m.x, m.y)
      return {
        left: pos.x,
        right: pos.x + m.ancho * INITIAL_ESCALA,
        top: pos.y,
        bottom: pos.y + m.alto * INITIAL_ESCALA,
      }
    })
    const minX = Math.min(...bounds.map((b) => b.left))
    const maxX = Math.max(...bounds.map((b) => b.right))
    const minY = Math.min(...bounds.map((b) => b.top))
    const maxY = Math.max(...bounds.map((b) => b.bottom))
    const contentW = maxX - minX
    const contentH = maxY - minY
    const scaleX = (dimensions.width - PADDING_STAGE) / contentW
    const scaleY = (dimensions.height - PADDING_STAGE) / contentH
    const dynamicScale = Math.min(scaleX, scaleY, 1)
    return {
      x:
        dimensions.width / 2 -
        (contentW * dynamicScale) / 2 -
        minX * dynamicScale,
      y:
        dimensions.height / 2 -
        (contentH * dynamicScale) / 2 -
        minY * dynamicScale,
      scale: dynamicScale,
    }
  }, [modulos, dimensions])

  const estaOcupado = (x: number, y: number) =>
    modulos.some((m) => m.x === x && m.y === y)

  const handleConfirmarModulo = () => {
    if (isEditing) {
      setModulos(
        modulos.map((m) =>
          m.id === selectedId ? { ...m, tipo, ancho, alto } : m,
        ),
      )
    } else {
      const coords = targetCoords || { x: 0, y: 0 }
      const nuevo: Modulo = {
        id: uuidv4(),
        x: coords.x,
        y: coords.y,
        tipo,
        ancho,
        alto,
      }
      setModulos([...modulos, nuevo])
      setSelectedId(nuevo.id)
    }
    onOpenChangeConfig()
  }

  return (
    <>
      <Button
        onPress={onThisOpen}
        className='bg-zinc-950 text-white border border-zinc-800 hover:bg-zinc-900 h-10 px-8 font-bold rounded-xl'
        variant='bordered'
        startContent={<SiMaterialdesignicons size={17} />}
      >
        EDITOR DE ABERTURAS
      </Button>

      <Modal
        isOpen={isThisOpen}
        onOpenChange={onThisOpenChange}
        size='5xl'
        classNames={{
          base: 'max-h-[90vh] bg-[#050505] text-zinc-100 border border-zinc-800/80 shadow-2xl',
          header: 'border-b border-zinc-900 bg-black/60 backdrop-blur-xl',
          footer: 'border-t border-zinc-900 bg-black/60 backdrop-blur-xl',
        }}
      >
        <ModalContent>
          {(onClose) => (
            <>
              <ModalHeader className='flex justify-between items-center py-4 px-8'>
                <div className='flex flex-col'>
                  <h2 className='text-2xl font-bold tracking-tight text-white'>
                    Configuración Técnica
                  </h2>
                </div>
                <div className='flex gap-3 mr-6'>
                  {modulos.length > 0 && (
                    <Button
                      size='sm'
                      variant='flat'
                      color='warning'
                      radius='lg'
                      className='font-bold h-9 px-4 bg-zinc-900 text-zinc-400 hover:bg-zinc-800'
                      onPress={() => {
                        setModulos([])
                        setSelectedId(null)
                      }}
                    >
                      Reiniciar Diseño
                    </Button>
                  )}
                  {selectedId && (
                    <>
                      <Button
                        size='sm'
                        radius='lg'
                        className='bg-zinc-100 text-black hover:bg-white font-bold h-9 px-5 transition-transform'
                        onPress={() => {
                          const m = modulos.find((mod) => mod.id === selectedId)
                          if (m) {
                            setTipo(m.tipo)
                            setAncho(m.ancho)
                            setAlto(m.alto)
                            setIsEditing(true)
                            onOpenConfig()
                          }
                        }}
                      >
                        Editar Módulo
                      </Button>
                      <Button
                        size='sm'
                        variant='flat'
                        color='danger'
                        radius='lg'
                        className='font-bold h-9 px-5 bg-red-950/20 text-red-500 hover:bg-red-950/40'
                        onPress={() => {
                          setModulos(modulos.filter((m) => m.id !== selectedId))
                          setSelectedId(null)
                        }}
                      >
                        Eliminar
                      </Button>
                    </>
                  )}
                </div>
              </ModalHeader>

              <ModalBody className='p-0 overflow-hidden flex flex-col flex-1 bg-[#050505]'>
                {modulos.length === 0 ? (
                  <div className='flex flex-1 items-center justify-center w-full h-full p-10'>
                    <Button
                      onPress={() => {
                        setTargetCoords({ x: 0, y: 0 })
                        setIsEditing(false)
                        onOpenConfig()
                      }}
                      className='group w-full max-w-sm h-40 border border-dashed border-zinc-800 bg-transparent hover:border-zinc-500 flex flex-col gap-3 rounded-2xl transition-all'
                    >
                      <div className='w-12 h-12 rounded-full bg-zinc-900 flex items-center justify-center group-hover:bg-zinc-800 transition-colors'>
                        <span className='text-2xl text-zinc-400'>+</span>
                      </div>
                      <span className='text-zinc-500 font-bold tracking-widest text-xs'>
                        AÑADIR PAÑO INICIAL
                      </span>
                    </Button>
                  </div>
                ) : (
                  <div
                    ref={containerRef}
                    className='flex-1 w-full h-full relative overflow-hidden bg-[radial-gradient(#1a1a1a_1px,transparent_1px)] [background-size:24px_24px]'
                  >
                    {dimensions.width > 0 && (
                      <Stage
                        width={dimensions.width}
                        height={dimensions.height}
                        onClick={(e) =>
                          e.target === e.target.getStage() &&
                          setSelectedId(null)
                        }
                      >
                        <Layer
                          x={transform.x}
                          y={transform.y}
                          scaleX={transform.scale}
                          scaleY={transform.scale}
                        >
                          {modulos.map((m) => {
                            const pos = obtenerPosicionVisual(m.x, m.y)
                            const isSelected = selectedId === m.id
                            const anchoPx = m.ancho * INITIAL_ESCALA
                            const altoPx = m.alto * INITIAL_ESCALA

                            return (
                              <Group key={m.id} x={pos.x} y={pos.y}>
                                <Rect
                                  width={anchoPx}
                                  height={altoPx}
                                  // Cambiado a Zinc-900 y Zinc-800 para elegancia
                                  fill={isSelected ? '#27272a' : '#111111'}
                                  stroke={isSelected ? '#ffffff' : '#3f3f46'}
                                  strokeWidth={
                                    isSelected
                                      ? 2 / transform.scale
                                      : 1 / transform.scale
                                  }
                                  // Eliminado shadowBlur (vibrante)
                                  cornerRadius={2 / transform.scale}
                                  onClick={() => setSelectedId(m.id)}
                                />

                                <Text
                                  text={m.tipo.toUpperCase()}
                                  width={anchoPx}
                                  y={altoPx / 2 - 20 / transform.scale}
                                  align='center'
                                  fill={isSelected ? '#ffffff' : '#52525b'}
                                  fontSize={14 / transform.scale}
                                  fontStyle='bold'
                                  listening={false}
                                  letterSpacing={1.2}
                                />
                                <Text
                                  text={`${m.ancho} × ${m.alto}`}
                                  width={anchoPx}
                                  y={altoPx / 2 + 6 / transform.scale}
                                  align='center'
                                  fill={isSelected ? '#ffffff' : '#a1a1aa'}
                                  fontSize={17 / transform.scale}
                                  fontStyle='bold'
                                  listening={false}
                                />

                                {isSelected && (
                                  <>
                                    {!estaOcupado(m.x + 1, m.y) && (
                                      <BotonPlus
                                        x={anchoPx + SPACING / transform.scale}
                                        y={altoPx / 2}
                                        scaleFactor={transform.scale}
                                        onClick={() => {
                                          setTargetCoords({
                                            x: m.x + 1,
                                            y: m.y,
                                          })
                                          setIsEditing(false)
                                          onOpenConfig()
                                        }}
                                      />
                                    )}
                                    {!estaOcupado(m.x - 1, m.y) && (
                                      <BotonPlus
                                        x={-(SPACING / transform.scale)}
                                        y={altoPx / 2}
                                        scaleFactor={transform.scale}
                                        onClick={() => {
                                          setTargetCoords({
                                            x: m.x - 1,
                                            y: m.y,
                                          })
                                          setIsEditing(false)
                                          onOpenConfig()
                                        }}
                                      />
                                    )}
                                    {!estaOcupado(m.x, m.y + 1) && (
                                      <BotonPlus
                                        x={anchoPx / 2}
                                        y={altoPx + SPACING / transform.scale}
                                        scaleFactor={transform.scale}
                                        onClick={() => {
                                          setTargetCoords({
                                            x: m.x,
                                            y: m.y + 1,
                                          })
                                          setIsEditing(false)
                                          onOpenConfig()
                                        }}
                                      />
                                    )}
                                    {!estaOcupado(m.x, m.y - 1) && (
                                      <BotonPlus
                                        x={anchoPx / 2}
                                        y={-(SPACING / transform.scale)}
                                        scaleFactor={transform.scale}
                                        onClick={() => {
                                          setTargetCoords({
                                            x: m.x,
                                            y: m.y - 1,
                                          })
                                          setIsEditing(false)
                                          onOpenConfig()
                                        }}
                                      />
                                    )}
                                  </>
                                )}
                              </Group>
                            )
                          })}
                        </Layer>
                      </Stage>
                    )}
                  </div>
                )}
                {isOpenConfig && (
                  <ModalConfiguracion
                    isOpen={isOpenConfig}
                    onOpenChange={onOpenChangeConfig}
                    ancho={ancho}
                    alto={alto}
                    tipo={tipo}
                    setAncho={setAncho}
                    setAlto={setAlto}
                    setTipo={setTipo}
                    handleConfirmarModulo={handleConfirmarModulo}
                  />
                )}
              </ModalBody>
              <ModalFooter className='py-3 px-10 justify-between items-center'>
                <div className='flex gap-10'>
                  <div className='flex flex-col'>
                    <span className='text-[10px] text-zinc-600 font-bold uppercase tracking-wider'>
                      Módulos
                    </span>
                    <span className='text-xl font-mono font-bold text-zinc-200'>
                      {modulos.length.toString().padStart(2, '0')}
                    </span>
                  </div>
                </div>
                <div className='flex gap-2'>
                  <Button
                    variant='light'
                    className='text-zinc-500 hover:text-white font-medium px-6'
                    onPress={onClose}
                  >
                    Cancelar
                  </Button>
                  <Button
                    className='bg-zinc-100 text-black font-black px-12 h-10 rounded-xl hover:bg-white transition-all shadow-lg'
                    onPress={() => {
                      console.log('Finalizado:', modulos)
                      onClose()
                    }}
                  >
                    FINALIZAR DISEÑO
                  </Button>
                </div>
              </ModalFooter>
            </>
          )}
        </ModalContent>
      </Modal>
    </>
  )
}

const BotonPlus = ({
  x,
  y,
  onClick,
  scaleFactor,
}: {
  x: number
  y: number
  onClick: () => void
  scaleFactor: number
}) => {
  const [isHovered, setIsHovered] = useState(false)
  const size = 28 / scaleFactor // Un poco más pequeño y fino
  return (
    <Group
      x={x}
      y={y}
      offsetX={size / 2}
      offsetY={size / 2}
      onClick={(e) => {
        e.cancelBubble = true
        onClick()
      }}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      <Rect
        width={size}
        height={size}
        // Colores neutros: de negro a gris oscuro
        fill={isHovered ? '#27272a' : '#111111'}
        cornerRadius={4 / scaleFactor}
        stroke={isHovered ? '#71717a' : '#3f3f46'}
        strokeWidth={1 / scaleFactor}
      />
      <Text
        text='+'
        fill={isHovered ? '#ffffff' : '#a1a1aa'}
        width={size}
        height={size}
        align='center'
        verticalAlign='middle'
        fontSize={16 / scaleFactor}
        fontStyle='bold'
      />
    </Group>
  )
}
