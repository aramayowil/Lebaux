import { useState, useEffect, useRef, useLayoutEffect, useMemo } from 'react'
import {
  Modal,
  ModalContent,
  ModalBody,
  ModalFooter,
  Button,
  useDisclosure,
} from '@heroui/react'
import {
  Stage,
  Layer,
  Group,
  Rect,
  Text,
  Image as KonvaImage,
} from 'react-konva'
import { v4 as uuidv4 } from 'uuid'
import { SiMaterialdesignicons } from 'react-icons/si'
import {
  HiOutlineRefresh,
  HiOutlineTrash,
  HiX,
  HiAdjustments,
} from 'react-icons/hi'
import { useImage } from 'react-konva-utils'
import ModalAgregar from '@/components/ui/modals/abertura_unificada/ModalAgregar'

const ImageContainer = ({
  src,
  width,
  height,
}: {
  src: string
  width: number
  height: number
}) => {
  const [image, status] = useImage(src)
  if (status !== 'loaded') return null
  return (
    <KonvaImage
      image={image}
      x={0}
      y={0}
      width={width}
      height={height}
      opacity={0.9}
    />
  )
}

const INITIAL_ESCALA = 0.2
const SPACING = 20
const PADDING_STAGE = 100
const STORAGE_KEY = 'diseno_modulos_blueprint_v3'

export default function AberturaCompuesta() {
  const [tipo, setTipo] = useState<string>('')
  const [ancho, setAncho] = useState<number>(1000)
  const [alto, setAlto] = useState<number>(1000)
  const [imgSrc, setImgSrc] = useState<string>('')
  const [showModal, setShowModal] = useState(false)

  const {
    isOpen: isThisOpen,
    onOpen: onThisOpen,
    onOpenChange: onThisOpenChange,
  } = useDisclosure()
  const containerRef = useRef<HTMLDivElement>(null)
  const [dimensions, setDimensions] = useState({ width: 0, height: 0 })

  const updateSize = () => {
    if (containerRef.current) {
      const { offsetWidth, offsetHeight } = containerRef.current
      if (offsetWidth > 0 && offsetHeight > 0)
        setDimensions({ width: offsetWidth, height: offsetHeight })
    }
  }

  useLayoutEffect(() => {
    if (isThisOpen) {
      const timer = setTimeout(updateSize, 100)
      window.addEventListener('resize', updateSize)
      return () => {
        window.removeEventListener('resize', updateSize)
        clearTimeout(timer)
      }
    }
  }, [isThisOpen])

  const [modulos, setModulos] = useState<any[]>(() => {
    if (typeof window !== 'undefined') {
      const saved = localStorage.getItem(STORAGE_KEY)
      return saved ? JSON.parse(saved) : []
    }
    return []
  })

  const [selectedId, setSelectedId] = useState<string | null>(null)
  const [isEditing, setIsEditing] = useState(false)
  const [targetCoords, setTargetCoords] = useState<{
    x: number
    y: number
  } | null>(null)

  useEffect(() => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(modulos))
  }, [modulos])

  const obtenerPosicionVisual = (coordX: number, coordY: number) => {
    let visualX = 0,
      visualY = 0
    if (coordX > 0) {
      for (let i = 0; i < coordX; i++)
        visualX +=
          (modulos.find((m) => m.x === i)?.ancho || 1000) * INITIAL_ESCALA
    } else if (coordX < 0) {
      for (let i = -1; i >= coordX; i--)
        visualX -=
          (modulos.find((m) => m.x === i)?.ancho || 1000) * INITIAL_ESCALA
    }
    if (coordY > 0) {
      for (let j = 0; j < coordY; j++)
        visualY +=
          (modulos.find((m) => m.y === j)?.alto || 1000) * INITIAL_ESCALA
    } else if (coordY < 0) {
      for (let j = -1; j >= coordY; j--)
        visualY -=
          (modulos.find((m) => m.y === j)?.alto || 1000) * INITIAL_ESCALA
    }
    return { x: visualX, y: visualY }
  }

  const transform = useMemo(() => {
    if (modulos.length === 0 || dimensions.width === 0)
      return { x: 50, y: 50, scale: 1 }
    const bounds = modulos.map((m) => {
      const pos = obtenerPosicionVisual(m.x, m.y)
      return {
        l: pos.x,
        r: pos.x + m.ancho * INITIAL_ESCALA,
        t: pos.y,
        b: pos.y + m.alto * INITIAL_ESCALA,
      }
    })
    const minX = Math.min(...bounds.map((b) => b.l)),
      maxX = Math.max(...bounds.map((b) => b.r))
    const minY = Math.min(...bounds.map((b) => b.t)),
      maxY = Math.max(...bounds.map((b) => b.b))
    const contentW = maxX - minX,
      contentH = maxY - minY
    const dynamicScale = Math.min(
      (dimensions.width - PADDING_STAGE) / (contentW || 1),
      (dimensions.height - PADDING_STAGE) / (contentH || 1),
      1,
    )
    return {
      x:
        dimensions.width / 2 -
        (contentW * dynamicScale) / 2 -
        minX * dynamicScale,
      y:
        dimensions.height / 2 -
        (contentH * dynamicScale) / 2 -
        minY * dynamicScale,
      scale: dynamicScale,
    }
  }, [modulos, dimensions])

  const handleReset = () => {
    if (window.confirm('¿Restablecer el lienzo de trabajo?')) {
      setModulos([])
      setSelectedId(null)
    }
  }

  const handleConfirmarModulo = () => {
    if (isEditing) {
      setModulos(
        modulos.map((m) =>
          m.id === selectedId ? { ...m, tipo, ancho, alto, imgSrc } : m,
        ),
      )
    } else {
      const coords = targetCoords || { x: 0, y: 0 }
      const nuevo = {
        id: uuidv4(),
        x: coords.x,
        y: coords.y,
        tipo,
        ancho,
        alto,
        imgSrc,
      }
      setModulos([...modulos, nuevo])
      setSelectedId(nuevo.id)
    }
    setShowModal(false)
  }

  return (
    <>
      <Button
        onPress={onThisOpen}
        className='bg-zinc-950 text-zinc-300 border border-zinc-800 hover:border-zinc-600 h-10 px-6 font-bold rounded-xl'
        startContent={<SiMaterialdesignicons size={18} />}
      >
        CONFIGURADOR TÉCNICO
      </Button>

      {showModal && (
        <ModalAgregar
          onClose={() => setShowModal(false)}
          handleConfirmarModulo={handleConfirmarModulo}
          setAncho={setAncho}
          setAlto={setAlto}
          setTipo={setTipo}
          setImgSrc={setImgSrc}
        />
      )}

      <Modal
        isOpen={isThisOpen}
        onOpenChange={onThisOpenChange}
        size='full'
        classNames={{ base: 'bg-[#0c0c0e] text-zinc-100', wrapper: 'p-0' }}
        hideCloseButton
      >
        <ModalContent>
          {(onClose) => (
            <>
              {/* HEADER FORMAL */}
              <div className='h-16 flex justify-between items-center px-10 border-b border-zinc-800/50 bg-black/40 backdrop-blur-md z-50'>
                <div className='flex items-center gap-4'>
                  <HiAdjustments className='text-zinc-500' size={20} />
                  <h2 className='text-sm font-bold tracking-0.1em text-zinc-200 uppercase'>
                    Sistema de Composición de Aberturas{' '}
                    <span className='text-zinc-600 ml-2 font-mono'>v3.0</span>
                  </h2>
                </div>

                <div className='flex items-center gap-3'>
                  {modulos.length > 0 && (
                    <Button
                      size='sm'
                      variant='bordered'
                      className='border-zinc-800 text-zinc-500 hover:text-red-400 hover:bg-red-500/5 px-4 font-bold'
                      startContent={<HiOutlineRefresh size={14} />}
                      onPress={handleReset}
                    >
                      Limpiar Canvas
                    </Button>
                  )}

                  {selectedId && (
                    <div className='flex items-center gap-1 bg-zinc-900/80 border border-zinc-800 p-1 rounded-lg'>
                      <Button
                        size='sm'
                        variant='light'
                        className='text-zinc-300 font-bold px-3'
                        onPress={() => {
                          const m = modulos.find((mod) => mod.id === selectedId)
                          if (m) {
                            setTipo(m.tipo)
                            setAncho(m.ancho)
                            setAlto(m.alto)
                            setImgSrc(m.imgSrc)
                            setIsEditing(true)
                            setShowModal(true)
                          }
                        }}
                      >
                        Modificar
                      </Button>
                      <div className='w-1px h-4 bg-zinc-800' />
                      <Button
                        size='sm'
                        variant='light'
                        color='danger'
                        isIconOnly
                        className='w-8'
                        onPress={() => {
                          setModulos(modulos.filter((m) => m.id !== selectedId))
                          setSelectedId(null)
                        }}
                      >
                        <HiOutlineTrash size={16} />
                      </Button>
                    </div>
                  )}

                  <div className='w-1px h-6 bg-zinc-800 mx-1' />

                  <Button
                    isIconOnly
                    variant='flat'
                    className='rounded-lg bg-zinc-900 text-zinc-500 hover:text-white'
                    onPress={onClose}
                  >
                    <HiX size={20} />
                  </Button>
                </div>
              </div>

              <ModalBody className='p-0 overflow-hidden relative flex-1'>
                <div
                  className='absolute inset-0 pointer-events-none opacity-[0.08]'
                  style={{
                    backgroundImage: `radial-gradient(#fff 1px, transparent 1px)`,
                    backgroundSize: '32px 32px',
                  }}
                />

                <div ref={containerRef} className='w-full h-full'>
                  {modulos.length === 0 ? (
                    <div className='flex h-full items-center justify-center'>
                      <Button
                        onPress={() => {
                          setTargetCoords({ x: 0, y: 0 })
                          setIsEditing(false)
                          setShowModal(true)
                        }}
                        className='group w-80 h-40 border border-zinc-800 bg-zinc-900/30 hover:border-zinc-600 rounded-2xl flex flex-col gap-2 transition-all'
                      >
                        <span className='text-2xl text-zinc-600 group-hover:text-zinc-300'>
                          +
                        </span>
                        <p className='text-xs font-bold tracking-widest text-zinc-500 uppercase'>
                          Iniciar Nuevo Diseño
                        </p>
                      </Button>
                    </div>
                  ) : (
                    <Stage
                      width={dimensions.width}
                      height={dimensions.height}
                      onClick={(e) =>
                        e.target === e.target.getStage() && setSelectedId(null)
                      }
                    >
                      <Layer
                        x={transform.x}
                        y={transform.y}
                        scaleX={transform.scale}
                        scaleY={transform.scale}
                      >
                        {modulos.map((m) => {
                          const pos = obtenerPosicionVisual(m.x, m.y)
                          const isSel = selectedId === m.id
                          const wPx = m.ancho * INITIAL_ESCALA,
                            hPx = m.alto * INITIAL_ESCALA
                          return (
                            <Group key={m.id} x={pos.x} y={pos.y}>
                              <ImageContainer
                                src={m.imgSrc}
                                width={wPx}
                                height={hPx}
                              />
                              <Rect
                                width={wPx}
                                height={hPx}
                                fill={
                                  isSel
                                    ? 'rgba(255,255,255,0.08)'
                                    : 'transparent'
                                }
                                stroke={isSel ? '#d4d4d8' : '#3f3f46'} // Gris claro en selección
                                strokeWidth={
                                  isSel
                                    ? 2 / transform.scale
                                    : 1.2 / transform.scale
                                }
                                cornerRadius={1 / transform.scale}
                                onClick={() => setSelectedId(m.id)}
                              />
                              <Text
                                text={`${m.tipo}\n${m.ancho}x${m.alto}mm`}
                                width={wPx}
                                height={hPx}
                                align='center'
                                verticalAlign='middle'
                                fill={isSel ? '#3f3f46' : '#71717a'}
                                fontSize={10 / transform.scale}
                                fontStyle='bold'
                                listening={false}
                              />
                              {isSel &&
                                [
                                  [1, 0],
                                  [-1, 0],
                                  [0, 1],
                                  [0, -1],
                                ].map(([dx, dy], i) => {
                                  if (
                                    modulos.some(
                                      (mod) =>
                                        mod.x === m.x + dx &&
                                        mod.y === m.y + dy,
                                    )
                                  )
                                    return null
                                  const bx =
                                    dx === 1
                                      ? wPx + SPACING / transform.scale
                                      : dx === -1
                                        ? -SPACING / transform.scale
                                        : wPx / 2
                                  const by =
                                    dy === 1
                                      ? hPx + SPACING / transform.scale
                                      : dy === -1
                                        ? -SPACING / transform.scale
                                        : hPx / 2
                                  return (
                                    <BotonPlusMinimal
                                      key={i}
                                      x={bx}
                                      y={by}
                                      scaleFactor={transform.scale}
                                      onClick={() => {
                                        setTargetCoords({
                                          x: m.x + dx,
                                          y: m.y + dy,
                                        })
                                        setIsEditing(false)
                                        setShowModal(true)
                                      }}
                                    />
                                  )
                                })}
                            </Group>
                          )
                        })}
                      </Layer>
                    </Stage>
                  )}
                </div>
              </ModalBody>

              <ModalFooter className='h-20 border-t border-zinc-800/50 bg-black/60 px-10'>
                <div className='flex-1'>
                  <span className='text-[10px] text-zinc-600 font-bold uppercase tracking-widest block'>
                    Módulos
                  </span>
                  <span className='text-xl font-mono font-bold text-zinc-200'>
                    {modulos.length}
                  </span>
                </div>
                <div className='flex gap-3'>
                  <Button
                    variant='light'
                    className='text-zinc-500 font-bold'
                    onPress={onClose}
                  >
                    DESCARTAR
                  </Button>
                  <Button
                    className='bg-white text-black font-bold px-10 rounded-xl hover:bg-zinc-200 transition-all'
                    onPress={onClose}
                  >
                    GUARDAR CAMBIOS
                  </Button>
                </div>
              </ModalFooter>
            </>
          )}
        </ModalContent>
      </Modal>
    </>
  )
}

const BotonPlusMinimal = ({
  x,
  y,
  onClick,
  scaleFactor,
}: {
  x: number
  y: number
  onClick: () => void
  scaleFactor: number
}) => {
  const [hover, setHover] = useState(false)
  const size = 32 / scaleFactor
  return (
    <Group
      x={x}
      y={y}
      offsetX={size / 2}
      offsetY={size / 2}
      cursor='pointer'
      onClick={(e) => {
        e.cancelBubble = true
        onClick()
      }}
      onMouseEnter={() => setHover(true)}
      onMouseLeave={() => setHover(false)}
    >
      <Rect
        width={size}
        height={size}
        fill={hover ? '#27272a' : '#18181b'} // Grises neutros
        stroke={hover ? '#71717a' : '#3f3f46'} // Borde gris claro en hover
        strokeWidth={1.5 / scaleFactor}
        cornerRadius={8 / scaleFactor}
      />
      <Text
        text='+'
        fill={hover ? '#fff' : '#52525b'}
        width={size}
        height={size}
        align='center'
        verticalAlign='middle'
        fontSize={18 / scaleFactor}
        fontStyle='bold'
        offsetY={1 / scaleFactor}
      />
    </Group>
  )
}
